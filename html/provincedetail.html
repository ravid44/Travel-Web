<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Province Detail</title>

  <link rel="shortcut icon" href="../images/khmer flag.jpg" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../css/home.css">
  <link rel="stylesheet" href="../css/header.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .headerImg img {
      width: 100%;
      max-height: 700px;
      object-fit: cover;
      border-radius: 10px;
      margin-top: -5rem;
      margin-bottom: 4rem;
    }

    /* === Unified Grid for All Categories === */
    #placesList,
    #coffeeShop,
    #hotels,
    #restElement {
      display: grid;
      grid-template-columns: repeat(3, 20%);
      gap: 4rem;
      justify-content: center;
      margin-top: 2rem;
      position: relative;
    }

    /* === Shared Card Style === */
    .place-card,
    .elementStyle {
      background-color: #fff;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
      position: relative;
    }

    .place-card:hover,
    .elementStyle:hover {
      transform: scale(1.03) translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .place-card img,
    .elementStyle img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .place-card .content,
    .elementStyle div {
      padding: 1rem;
      margin-top: 2rem;
    }

    .place-card h3,
    .elementStyle h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
      color: #333;
    }

    .place-card p,
    .elementStyle p {
      margin: 0.3rem 0;
      color: #555;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .place-card .content {
      padding: 15px;
    }

    .navMenu {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      padding-left: 5rem;
      padding-right: 5rem;
      margin-top: 1rem;
      width: 100%;
    }

    .navMenu:hover {
      color: blue;
    }

    .arrow i,
    .menuBars i {
      font-size: 3rem;
    }

    .myOption {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4rem;
      display: none;
      margin-top: 5rem;
    }

    .open-bar {
      display: flex;
    }

    .myOption a {
      text-decoration: none;
    }

    .headerImg {
      display: flex;
      justify-content: center;
      margin-top: 7rem;
    }

    .headerImg img {
      width: 100vw;
      object-fit: cover;
    }

    .mycoffeeText,
    .myCafesText,
    .myRestText {
      margin-top: 12rem;
    }

    .mycoffeeText h1,
    .myCafesText h1,
    .myRestText h1 {
      text-transform: uppercase;
    }

    /* === Section White Overlay === */
    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 10;
      display: none;
    }

    #viewMorePlaceBtn,
    #viewMoreCoffeeBtn,
    #viewMoreHotelsBtn,
    #viewMoreRestsBtn {
      display: none;
      padding: 20px 30px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 10%;
      margin-left: 20rem;
      margin-top: 2.5rem;
      font-size: 1.2rem;
    }

    #viewMorePlaceBtn:hover,
    #viewMoreCoffeeBtn:hover,
    #viewMoreHotelsBtn:hover,
    #viewMoreRestsBtn:hover {
      background: rgb(40, 40, 227);
    }

    /* === Loading Overlay === */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 2rem;
      font-weight: bold;
      color: #1a73e8;
      font-family: Arial, sans-serif;
    }

    .myIcon {
      position: absolute;
      right: 0;
      bottom: 1rem;
      left: 89%;
      /* remove your margin-left/margin-top */
    }

    .myHeartICafe,
    .myHeartIHotel {
      position: absolute;
      bottom: 0;
      /* same distance from bottom */
      left: 85%;
      /* same distance from right */
      margin: 0;
      /* remove your margin-left/margin-top */
    }

    .myHeart i,
    .myHeartICafe i,
    .myHeartIHotel i,
    .myIcon i {
      font-size: 1.5rem;
      cursor: pointer;
      transition: 0.2s;
    }


    /* Section overlay */
    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 10;
      display: none;
    }

    #viewMorePlaceBtn,
    #viewMoreCoffeeBtn,
    #viewMoreHotelsBtn,
    #viewMoreRestsBtn {
      display: none;
      padding: 20px 30px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      margin: 2rem auto;
      display: block;
    }

    #viewMorePlaceBtn:hover,
    #viewMoreCoffeeBtn:hover,
    #viewMoreHotelsBtn:hover,
    #viewMoreRestsBtn:hover {
      background: rgb(40, 40, 227);
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 2rem;
      font-weight: bold;
      color: #1a73e8;
      font-family: Arial, sans-serif;
    }

    .myHeart,
    .myIcon,
    .myHeartICafe,
    .myHeartIHotel {
      position: absolute;
      bottom: 0.1rem;
      right: 0.2rem;
      cursor: pointer;
      font-size: 1.5rem;
      transition: 0.2s;
    }

    .myHeart {
      transition: color 0.2s ease-in-out, transform 0.2s;
    }

    .myHeart:active {
      transform: scale(1.2);
    }


    /*
    .myHeart i:hover,
    .myIcon i:hover,
    .myHeartICafe i:hover,
    .myHeartIHotel i:hover {
      
    }
    */
  </style>
</head>

<body>
  <!--header-->
  <div id="header-placeholder"></div>

  <div id="loadingOverlay">Loading...</div>

  <main>
    <div class="headerImg"></div>
    <h1 id="provinceName"></h1>

    <section>
      <div id="placesList"></div>
      <button id="viewMorePlaceBtn">View More</button>
    </section>


    <section>
      <h1>Coffee Shops</h1>
      <div id="coffeeShop">
        <div class="section-overlay" id="coffeeOverlay"></div>
      </div>
      <button id="viewMoreCoffeeBtn">View More</button>
    </section>

    <section>
      <h1>Hotels</h1>
      <div id="hotels">
        <div class="section-overlay" id="hotelOverlay"></div>
      </div>
      <button id="viewMoreHotelsBtn">View More</button>
    </section>

    <section>
      <h1>Restaurants</h1>
      <div id="restElement">
        <div class="section-overlay" id="restOverlay"></div>
      </div>
      <button id="viewMoreRestsBtn">View More</button>
    </section>

    <section id="maps"></section>
  </main>

  <!--footer-->
  <footer id="footer">
  </footer>
  <script src="../js/home.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // -------------------- FIREBASE --------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCwZvlhgluWctDaCy_hEiVOsDO9AbVLpnA",
      authDomain: "web-travel-19d2c.firebaseapp.com",
      projectId: "web-travel-19d2c",
      storageBucket: "web-travel-19d2c.firebasestorage.app",
      messagingSenderId: "850178211857",
      appId: "1:850178211857:web:c22077d5d1c892f7b071b0",
      measurementId: "G-JF6LPNDYF9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -------------------- GLOBALS --------------------
    const params = new URLSearchParams(window.location.search);
    let provinceId = params.get("provinceId") || localStorage.getItem("lastProvinceId");
    console.log("provinceId:", provinceId);

    if (!provinceId) alert("Province not selected!");
    else localStorage.setItem("lastProvinceId", provinceId);

    const provinceNameEl = document.getElementById("provinceName");
    console.log("provinceNameEl:", provinceNameEl);

    const headerImg = document.querySelector(".headerImg");
    const myMaps = document.getElementById("maps");

    let allPlaces = [], isExpanded = false;
    let allCoffees = [], coffeeExpanded = false;
    let allHotels = [], hotelExpanded = false;
    let allRests = [], restExpanded = false;



    // -------------------- INIT --------------------
    window.addEventListener("DOMContentLoaded", async () => {
      await loadUserFavorites();   // Load favorites first
      await loadAllData();         // Load all sections
      markFavoriteHearts();        // Mark red hearts
    });

    // -------------------- LOAD ALL DATA --------------------
    async function loadAllData() {
      await loadProvinceInfo(provinceId);
      await loadPlacesByProvince(provinceId);
      lazyLoadSection("coffeeShop", loadCoffees, "coffeeOverlay");
      lazyLoadSection("hotels", loadHotels, "hotelOverlay");
      lazyLoadSection("restElement", loadRests, "restOverlay");
      document.getElementById("loadingOverlay").style.display = "none";
    }

    // -------------------- LOAD PROVINCE INFO --------------------
    async function loadProvinceInfo(provinceId) {
      const q = query(collection(db, "provincesCambodia"), where("provinceId", "==", provinceId));
      console.log("qPro:", q);

      const snapshot = await getDocs(q);
      console.log("snapshotPro:", snapshot);

      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        console.log("dataIn", data);

        headerImg.innerHTML = `<img src="${data.image}" alt="${data.name}">`;
        provinceNameEl.textContent = data.name;

        if (data.location) {
          const { lat, lng } = data.location;
          console.log("lat, lng:", lat, lng);

          myMaps.innerHTML = `<iframe src="https://www.google.com/maps?q=${lat},${lng}&hl=es;z=14&output=embed"
        width="100%" height="450" style="border:0;" allowfullscreen loading="lazy"></iframe>`;
        } else {
          myMaps.innerHTML = `<p>Map not available for ${data.name}</p>`;
        }

        console.log("MapPro:", myMaps);
      }
    }

    // -------------------- RENDER FUNCTION HELPER --------------------
    function renderSection(items, containerId, type, expanded, setExpanded) {
      const section = document.getElementById(containerId);
      section.innerHTML = "";
      const showItems = expanded ? items : items.slice(0, 6);
      console.log("showItems:", showItems);

      showItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "elementStyle";
        div.setAttribute("data-id", item.id);
        div.setAttribute("data-type", type);
        div.innerHTML = `
      <img src="${item.image || item.image_placeholder || 'default.jpg'}" alt="${item.name}">
      <div class="content">
        <h3>${item.name}</h3>
        <p>${item.address || item.description || item.cuisine || "N/A"}</p>
        <div class="myHeart"><i class="fa-solid fa-heart"></i></div>
      </div>`;

        console.log("divRenderSec:", div);

        // Heart click
        div.querySelector(".myHeart").addEventListener("click", e => {
          e.stopPropagation();
          handleFavoriteClick(div, item, type);
        });

        // Navigate to detail
        div.querySelector("img").addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=${type}&id=${item.id}`;
        });

        section.appendChild(div);
      });

      // Handle View More button
      const btn = document.getElementById(`viewMore${capitalize(type)}Btn`);
      console.log(btn); // Should NOT be null now

      if (!btn) return;

      if (items.length <= 6) {
        btn.style.display = "none";
        return;
      }

      btn.style.display = "block";
      btn.textContent = expanded ? "View Less" : "View More";

      btn.onclick = async () => {
        const newExpanded = !expanded;   // must store new value first
        setExpanded(newExpanded);     // update global value
        console.log("newExpanded:", newExpanded);

        if (type === "place") {
          await loadPlacesByProvince();  // reload places first
        }

        renderSection(items, containerId, type, newExpanded, setExpanded); // use updated value
        markFavoriteHearts();
      };
    }

    // -------------------- LOAD SECTIONS --------------------
    async function loadPlacesByProvince() {
      const q = query(collection(db, "placesCambo"), where("provinceId", "==", provinceId));
      console.log("qPlaces:", q);
      const snapshot = await getDocs(q);


      if (!snapshot.empty) {
        allPlaces = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log("allPlaces:", allPlaces);

        // Always use the CURRENT expanded value
        renderSection(allPlaces, "placesList", "place", isExpanded, val => isExpanded = val);
        markFavoriteHearts();
      }
    }



    async function loadCoffees() {
      const q = query(collection(db, "cafeShopCambo"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        allCoffees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSection(allCoffees, "coffeeShop", "coffee", coffeeExpanded, val => coffeeExpanded = val);
        markFavoriteHearts();
      }
    }

    async function loadHotels() {
      const q = query(collection(db, "hotelCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        allHotels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSection(allHotels, "hotels", "hotel", hotelExpanded, val => hotelExpanded = val);
        markFavoriteHearts();
      }
    }

    async function loadRests() {
      const q = query(collection(db, "restaurantsCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        allRests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSection(allRests, "restElement", "restaurant", restExpanded, val => restExpanded = val);
        markFavoriteHearts();
      }
    }

    // -------------------- FAVORITES --------------------
    async function loadUserFavorites() {
      const userData = JSON.parse(localStorage.getItem("loggedInUser"));
      console.log("userData:", userData);
      if (!userData?.id) return;
      const q = query(collection(db, "userFavorites"), where("userId", "==", userData.id));
      console.log("qUserFav:", q);

      const snap = await getDocs(q);
      console.log("snapUserFav:", snap);
      const favorites = snap.docs.map(doc => ({
        fireId: doc.id,
        itemId: doc.data().itemId,
        type: doc.data().type
      }));
      console.log("favorites:", favorites);

      localStorage.setItem("favoritePlaces", JSON.stringify(favorites));
    }

    function markFavoriteHearts() {
      const favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];
      console.log("favHeart:", favorites);

      favorites.forEach(fav => {
        const card = document.querySelector(`[data-id='${fav.itemId}']`);
        console.log("card:", card);
        if (card) {
          const heart = card.querySelector(".fa-heart");
          if (heart) heart.style.color = "red";
          console.log("heart:", heart);
        }
      });
    }

    async function handleFavoriteClick(cardDiv, itemData, type) {
      const userData = JSON.parse(localStorage.getItem("loggedInUser"));
      if (!userData?.id) return alert("Please login first");
      console.log("userData:", userData);

      let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];
      const heart = cardDiv.querySelector(".myHeart");

      const existing = favorites.find(f => f.itemId === itemData.id);
      console.log("existingFav:",existing);

      // ⏩ 1) INSTANT UI UPDATE – FASTER CLICK RESPONSE
      if (!existing) {
        heart.style.color = "red"; // Turn RED instantly
      } else {
        heart.style.color = ""; // Turn back to default instantly
      }

      // ⛔ Prevent double click while processing
      heart.style.pointerEvents = "none";

      try {
        if (!existing) {
          // ADD TO FIREBASE
          const docRef = await addDoc(collection(db, "userFavorites"), {
            userId: userData.id,
            itemId: itemData.id,
            type,
            name: itemData.name,
            image: itemData.image || itemData.image_placeholder || "",
            address: itemData.address || itemData.description || itemData.cuisine || "",
            createdAt: new Date()
          });

          console.log("docRefFav:",docRef);

          favorites.push({ fireId: docRef.id, itemId: itemData.id, type });
          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));
        } else {
          // REMOVE FROM FIREBASE
          await deleteDoc(doc(db, "userFavorites", existing.fireId));

          favorites = favorites.filter(f => f.itemId !== itemData.id);
          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));
        }
      } catch (err) {
        console.error(err);
      }

      // ✔ Re-enable clicking
      heart.style.pointerEvents = "auto";
    }





    // -------------------- LAZY LOAD --------------------
    function lazyLoadSection(sectionId, loadFunction, overlayId) {
      const section = document.getElementById(sectionId);
      const overlay = document.getElementById(overlayId);
      if (!section) return;

      const rect = section.getBoundingClientRect();
      if (rect.top < window.innerHeight) {
        if (overlay) overlay.style.display = "block";
        loadFunction().finally(() => { if (overlay) overlay.style.display = "none"; });
        return;
      }

      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            if (overlay) overlay.style.display = "block";
            loadFunction().finally(() => { if (overlay) overlay.style.display = "none"; });
            obs.unobserve(entry.target);
          }
        });
      }, { threshold: 0.2 });
      observer.observe(section);
    }

    // -------------------- UTILS --------------------
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  </script>

</body>

</html>