<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Province Detail</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../css/home.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .headerImg img {
      width: 100%;
      max-height: 700px;
      object-fit: cover;
      border-radius: 10px;
      margin-top: -5rem;
      margin-bottom: 4rem;
    }

    /* === Unified Grid for All Categories === */
    #placesList,
    #coffeeShop,
    #hotels,
    #restElement {
      display: grid;
      grid-template-columns: repeat(3, 20%);
      gap: 4rem;
      justify-content: center;
      margin-top: 2rem;
      position: relative;
    }

    /* === Shared Card Style === */
    .place-card,
    .elementStyle {
      background-color: #fff;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
      position: relative;
    }

    .place-card:hover,
    .elementStyle:hover {
      transform: scale(1.03) translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .place-card img,
    .elementStyle img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .place-card .content,
    .elementStyle div {
      padding: 1rem;
      margin-top: 2rem;
    }

    .place-card h3,
    .elementStyle h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
      color: #333;
    }

    .place-card p,
    .elementStyle p {
      margin: 0.3rem 0;
      color: #555;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .place-card .content {
      padding: 15px;
    }

    .navMenu {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      padding-left: 5rem;
      padding-right: 5rem;
      margin-top: 1rem;
      width: 100%;
    }

    .navMenu:hover {
      color: blue;
    }

    .arrow i,
    .menuBars i {
      font-size: 3rem;
    }

    .myOption {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4rem;
      display: none;
      margin-top: 5rem;
    }

    .open-bar {
      display: flex;
    }

    .myOption a {
      text-decoration: none;
    }

    .headerImg {
      display: flex;
      justify-content: center;
      margin-top: 7rem;
    }

    .headerImg img {
      width: 100vw;
      object-fit: cover;
    }

    .mycoffeeText,
    .myCafesText,
    .myRestText {
      margin-top: 12rem;
    }

    .mycoffeeText h1,
    .myCafesText h1,
    .myRestText h1 {
      text-transform: uppercase;
    }

    /* === Section White Overlay === */
    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 10;
      display: none;
    }

    #viewMoreBtn,
    #viewMoreCoffeeBtn,
    #viewMoreHotelsBtn,
    #viewMoreRestsBtn {
      display: none;
      padding: 20px 30px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 10%;
      margin-left: 20rem;
      margin-top: 2.5rem;
      font-size: 1.2rem;
    }

    #viewMoreBtn:hover,
    #viewMoreCoffeeBtn:hover,
    #viewMoreHotelsBtn:hover,
    #viewMoreRestsBtn:hover {
      background: rgb(40, 40, 227);
    }

    /* === Loading Overlay === */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 2rem;
      font-weight: bold;
      color: #1a73e8;
      font-family: Arial, sans-serif;
    }

    .myIcon {
      position: absolute;
      right: 0;
      bottom: 1rem;
      left: 89%;
      /* remove your margin-left/margin-top */
    }

    .myHeartICafe,
    .myHeartIHotel {
      position: absolute;
      bottom: 0;
      /* same distance from bottom */
      left: 85%;
      /* same distance from right */
      margin: 0;

      /* remove your margin-left/margin-top */
    }

    .myHeartICafe i,
    .myHeartIHotel i,
    .myIcon i {
      font-size: 1.5rem;
      cursor: pointer;
      transition: 0.2s;
    }




    .myHeartICafe i:hover,
    .myHeartIHotel i:hover,
    .myIcon i:hover {
      color: red;
    }
  </style>
</head>

<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div class="loadingText">Loading...</div>
  </div>

  <!--header-->
  <div id="header-placeholder"></div>

  <main>
    <div class="headerImg"></div>
    <h1 id="provinceName"></h1>

    <section>
      <div id="placesList"></div>
      <button id="viewMoreBtn">View More</button>
    </section>

    <section>
      <div class="mycoffeeText">
        <h1>coffee shop</h1>
      </div>
      <div id="coffeeShop">
        <div class="section-overlay" id="coffeeOverlay"></div>
      </div>
      <button id="viewMoreCoffeeBtn">View More</button>
    </section>

    <section>
      <div class="myCafesText">
        <h1>hotels</h1>
      </div>
      <div id="hotels">
        <div class="section-overlay" id="hotelOverlay"></div>
      </div>
      <button id="viewMoreHotelsBtn">View More</button>
    </section>

    <section>
      <div class="myRestText">
        <h1>restaurants</h1>
      </div>
      <div id="restElement">
        <div class="section-overlay" id="restOverlay"></div>
      </div>
      <button id="viewMoreRestsBtn">View More</button>
    </section>

    <section id="maps"></section>
  </main>



  <!--footer-->
  <footer id="footer"></footer>



  <script src="../js/home.js"></script>

  <script>
    let myMenu = document.querySelector(".menuBars");
    let myThreeMenu = document.querySelector(".myOption");
    let arrow = document.getElementById("myArrow");

    myMenu?.addEventListener("click", () => {
      myThreeMenu.classList.toggle("open-bar");
    });

    arrow?.addEventListener("click", () => {
      window.location.href = "province.html";
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwZvlhgluWctDaCy_hEiVOsDO9AbVLpnA",
      authDomain: "web-travel-19d2c.firebaseapp.com",
      projectId: "web-travel-19d2c",
      storageBucket: "web-travel-19d2c.firebasestorage.app",
      messagingSenderId: "850178211857",
      appId: "1:850178211857:web:c22077d5d1c892f7b071b0",
      measurementId: "G-JF6LPNDYF9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const provinceId = params.get('id');

    // SAVE THIS provinceId for storedata.html
    localStorage.setItem("lastProvinceId", provinceId);

    const provinceNameEl = document.getElementById("provinceName");
    const placesList = document.getElementById("placesList");
    const headerImg = document.querySelector(".headerImg");
    const myMaps = document.getElementById("maps");

    async function loadAllData() {
      if (!provinceId) {
        provinceNameEl.textContent = "âŒ Invalid province ID";
        return;
      }

      await loadProvinceInfo(provinceId);
      await loadPlacesByProvince(provinceId);

      lazyLoadSection("coffeeShop", loadcoffees, "coffeeOverlay");
      lazyLoadSection("hotels", loadHotels, "hotelOverlay");
      lazyLoadSection("restElement", loadRests, "restOverlay");
    }

    // === Show loading overlay while loading data ===
    async function loadAllDataWithOverlay() {
      try {
        loadingOverlay.style.display = 'flex';
        await loadAllData();
      } catch (err) {
        console.error(err);
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    window.addEventListener("DOMContentLoaded", loadAllDataWithOverlay);

    // === All your Firebase load/render functions below ===
    async function loadProvinceInfo(provinceId) {
      const q = query(collection(db, "provincesCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        provinceNameEl.textContent = "Province not found";
        return;
      }
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        headerImg.innerHTML = `<img src="${data.image}" alt="${data.name}">`;
        provinceNameEl.textContent = data.name;
        if (data.location) {
          const lat = data.location.lat;
          const lng = data.location.lng;
          myMaps.innerHTML = `<iframe src="https://www.google.com/maps?q=${lat},${lng}&hl=es;z=14&output=embed"
          width="100%" height="450" style="border:0;" allowfullscreen loading="lazy"></iframe>`;
        } else {
          myMaps.innerHTML = `<p>Map not available for ${data.name}</p>`;
        }
      });
    }

    // Your Places, Coffee, 

    // ==================== Places =====================
    let allPlaces = [], visibleCount = 6, isExpanded = false;
    console.log("isExpanded:", isExpanded);

    async function loadPlacesByProvince(provinceId) {
      const q = query(collection(db, "placesCambo"), where("provinceId", "==", provinceId));
      console.log("q:",q);

      const snapshot = await getDocs(q);
      console.log("snapshotPlaces:", snapshot);

      if (snapshot.empty) return;
      allPlaces = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      console.log("allPlaces:", allPlaces);
      renderPlaces();
    }

    function renderPlaces() {
      placesList.innerHTML = "";
      const showItems = isExpanded ? allPlaces : allPlaces.slice(0, visibleCount);
      console.log("showItems:", showItems);

      showItems.forEach(data => {
        const div = document.createElement("div");
        div.className = "place-card";
        div.innerHTML = `
          <img class="detailPlace" src="${data.image}" alt="${data.name}">
          <div class="content">
            <h3>${data.name}</h3>
            <p>${data.description}</p>

            <div class="myIcon">
              <i class="fa-solid fa-heart"></i>
            </div>
          </div>`;
        placesList.appendChild(div);

        div.querySelector(".detailPlace").addEventListener("click", () => {
          window.location.href = `placesdetails.html?id=${data.id}`;
        });

        /*
        const hIcon = document.getElementById("myIcon");
        hIcon.addEventListener("click", () => {
            localStorage.setItem("favoritePlace", JSON.stringify(data));
            window.location.href = "../html/storedata.html";
        });
       */


        // Store data on heart click
        div.querySelector(".myIcon").addEventListener("click", () => {
          console.log("div:", div);
          // Get current favorites from localStorage, or empty array
          let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];
          console.log("favorites:", favorites);

          // Add the new place if not already in favorites
          if (!favorites.some(f => f.id === data.id)) {
            favorites.push(data);
          }

          // Save back to localStorage
          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));

          alert(`${data.name} has been added to favorites!`);
          window.location.href = "../html/storedata.html";
        });


      });
      const viewMoreBtn = document.getElementById("viewMoreBtn");
      viewMoreBtn.textContent = isExpanded ? "View Less" : "View More";
      viewMoreBtn.style.display = "block";
    }

    document.getElementById("viewMoreBtn").addEventListener("click", () => {
      isExpanded = !isExpanded;
      renderPlaces();
    });

    // ==================== Lazy-load Helper =====================
    function lazyLoadSection(sectionId, loadFunction, overlayId) {
      const section = document.getElementById(sectionId);
      const overlay = document.getElementById(overlayId);
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            overlay.style.display = "block";
            loadFunction().finally(() => overlay.style.display = "none");
            obs.unobserve(entry.target);
          }
        });
      }, { root: null, threshold: 0.2 });
      observer.observe(section);
    }

    // ==================== Coffee Shops =====================
    let allCoffees = [], coffeeVisibleCount = 6, coffeeExpanded = false;

    async function loadcoffees() {
      const q = query(collection(db, "cafeShopCambo"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      const myCafe = document.getElementById("coffeeShop");
      myCafe.innerHTML = "";
      if (snapshot.empty) return;
      allCoffees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderCoffees();
    }

    function renderCoffees() {
      const myCafe = document.getElementById("coffeeShop");
      myCafe.innerHTML = "";
      const showItems = coffeeExpanded ? allCoffees : allCoffees.slice(0, coffeeVisibleCount);

      showItems.forEach(coffee => {
        const divCoffee = document.createElement("div");
        divCoffee.classList.add("elementStyle");
        divCoffee.style.cursor = "pointer";

        const coffeeId = coffee.id || `${coffee.name.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_${coffee.provinceId}`;

        divCoffee.innerHTML = `
      <img class="detailPlace" src="${coffee.image || coffee.image_placeholder}" alt="${coffee.name}">
      <div class="content">
        <h3>${coffee.name}</h3>
        <p>${coffee.address}</p>
        <p>${coffee.focus || "N/A"}</p>

        <div class="myHeartICafe">
          <i class="fa-solid fa-heart"></i>
        </div>
      </div>
    `;

        // ðŸŸ¦ MAIN CARD CLICK
        divCoffee.addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=coffee&id=${coffeeId}`;
        });

        // â¤ï¸ HEART CLICK â€” FIXED
        const heart = divCoffee.querySelector(".myHeartICafe");
        heart.addEventListener("click", (event) => {
          event.stopPropagation();  // â— Prevent redirect

          let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];

          if (!favorites.some(f => f.id === coffee.id)) {
            favorites.push(coffee);
          }

          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));

          alert(`${coffee.name} has been added to favorites!`);
          window.location.href = "../html/storedata.html";
        });

        myCafe.appendChild(divCoffee);
      });

      const coffeeBtn = document.getElementById("viewMoreCoffeeBtn");
      coffeeBtn.textContent = coffeeExpanded ? "View Less" : "View More";
      coffeeBtn.style.display = "block";
    }


    document.getElementById("viewMoreCoffeeBtn").addEventListener("click", () => {
      coffeeExpanded = !coffeeExpanded;
      renderCoffees();
    });

    // ==================== Hotels =====================
    let allHotels = [], hotelVisibleCount = 6, hotelExpanded = false;

    async function loadHotels() {
      const q = query(collection(db, "hotelCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      const myHotels = document.getElementById("hotels");
      myHotels.innerHTML = "";
      if (snapshot.empty) return;
      allHotels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderHotels();
    }

    function renderHotels() {
      const myHotels = document.getElementById("hotels");
      myHotels.innerHTML = "";
      const showItems = hotelExpanded ? allHotels : allHotels.slice(0, hotelVisibleCount);

      showItems.forEach(hotel => {
        const hotelId = hotel.id || `${hotel.name.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_${hotel.provinceId}`;
        const divHotel = document.createElement("div");
        divHotel.classList.add("elementStyle");
        divHotel.style.cursor = "pointer";

        divHotel.innerHTML = `
      <img class="detailPlace" src="${hotel.image || hotel.image_placeholder || 'default.jpg'}" alt="${hotel.name}">
      <div class="content">
        <h3>${hotel.name}</h3>
        <p>${hotel.address || "N/A"}</p>
        <p>${hotel.focus || "N/A"}</p>

        <div class="myHeartIHotel">
          <i class="fa-solid fa-heart"></i>
        </div>
      </div>
    `;

        // ðŸŸ¦ MAIN HOTEL CARD CLICK (go to detail)
        divHotel.addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=hotel&id=${hotelId}`;
        });

        // â¤ï¸ HEART CLICK â€” SAME AS COFFEE
        const heart = divHotel.querySelector(".myHeartIHotel");
        heart.addEventListener("click", (event) => {
          event.stopPropagation();  // â— stop detail redirect

          let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];

          if (!favorites.some(f => f.id === hotel.id)) {
            favorites.push(hotel);
          }

          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));

          alert(`${hotel.name} has been added to favorites!`);
          window.location.href = "../html/storedata.html";
        });

        myHotels.appendChild(divHotel);
      });

      const hotelBtn = document.getElementById("viewMoreHotelsBtn");
      hotelBtn.textContent = hotelExpanded ? "View Less" : "View More";
      hotelBtn.style.display = "block";
    }


    // ==================== Restaurants =====================
    let allRests = [], restVisibleCount = 6, restExpanded = false;

    async function loadRests() {
      const q = query(collection(db, "restaurantsCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      const myRest = document.getElementById("restElement");
      myRest.innerHTML = "";
      if (snapshot.empty) return;
      allRests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderRests();
    }

    function renderRests() {
      const myRest = document.getElementById("restElement");
      myRest.innerHTML = "";
      const showItems = restExpanded ? allRests : allRests.slice(0, restVisibleCount);

      showItems.forEach(rest => {
        const restId = rest.id || `${rest.name.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_')}_${rest.provinceId}`;
        const divRest = document.createElement("div");
        divRest.classList.add("elementStyle");
        divRest.style.cursor = "pointer";

        divRest.innerHTML = `
      <img class="detailPlace" src="${rest.image || rest.image_placeholder || 'default.jpg'}" alt="${rest.name}">
      <div class="content">
        <h3>${rest.name}</h3>
        <p>Cuisine: ${rest.cuisine || "N/A"}</p>
        <p>Description: ${rest.short_description}</p>
        

        <div class="myHeartICafe">
          <i class="fa-solid fa-heart"></i>
        </div>
      </div>
    `;

        // ðŸŸ¦ MAIN CARD CLICK
        divRest.addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=restaurant&id=${restId}`;
        });

        // â¤ï¸ HEART CLICK â€” ADD TO FAVORITES
        const heart = divRest.querySelector(".myHeartICafe");
        heart.addEventListener("click", (event) => {
          event.stopPropagation(); // â— Stop detail redirect

          let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];

          if (!favorites.some(f => f.id === rest.id)) {
            favorites.push(rest);
          }

          localStorage.setItem("favoritePlaces", JSON.stringify(favorites));

          alert(`${rest.name} has been added to favorites!`);
          window.location.href = "../html/storedata.html";
        });

        myRest.appendChild(divRest);
      });

      const restBtn = document.getElementById("viewMoreRestsBtn");
      restBtn.textContent = restExpanded ? "View Less" : "View More";
      restBtn.style.display = "block";
    }


    window.addEventListener("DOMContentLoaded", loadAllData);

  </script>
</body>

</html>