<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Province Detail</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../css/home.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .headerImg img {
      width: 100%;
      max-height: 700px;
      object-fit: cover;
      border-radius: 10px;
      margin-top: -5rem;
      margin-bottom: 4rem;
    }

    /* === Unified Grid for All Categories === */
    #placesList,
    #coffeeShop,
    #hotels,
    #restElement {
      display: grid;
      grid-template-columns: repeat(3, 20%);
      gap: 4rem;
      justify-content: center;
      margin-top: 2rem;
      position: relative;
    }

    /* === Shared Card Style === */
    .place-card,
    .elementStyle {
      background-color: #fff;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
      position: relative;
    }

    .place-card:hover,
    .elementStyle:hover {
      transform: scale(1.03) translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .place-card img,
    .elementStyle img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .place-card .content,
    .elementStyle div {
      padding: 1rem;
      margin-top: 2rem;
    }

    .place-card h3,
    .elementStyle h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
      color: #333;
    }

    .place-card p,
    .elementStyle p {
      margin: 0.3rem 0;
      color: #555;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .place-card .content {
      padding: 15px;
    }

    .navMenu {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      padding-left: 5rem;
      padding-right: 5rem;
      margin-top: 1rem;
      width: 100%;
    }

    .navMenu:hover {
      color: blue;
    }

    .arrow i,
    .menuBars i {
      font-size: 3rem;
    }

    .myOption {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4rem;
      display: none;
      margin-top: 5rem;
    }

    .open-bar {
      display: flex;
    }

    .myOption a {
      text-decoration: none;
    }

    .headerImg {
      display: flex;
      justify-content: center;
      margin-top: 7rem;
    }

    .headerImg img {
      width: 100vw;
      object-fit: cover;
    }

    .mycoffeeText,
    .myCafesText,
    .myRestText {
      margin-top: 12rem;
    }

    .mycoffeeText h1,
    .myCafesText h1,
    .myRestText h1 {
      text-transform: uppercase;
    }

    /* === Section White Overlay === */
    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 10;
      display: none;
    }

    #viewMoreBtn,
    #viewMoreCoffeeBtn,
    #viewMoreHotelsBtn,
    #viewMoreRestsBtn {
      display: none;
      padding: 20px 30px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 10%;
      margin-left: 20rem;
      margin-top: 2.5rem;
      font-size: 1.2rem;
    }

    #viewMoreBtn:hover,
    #viewMoreCoffeeBtn:hover,
    #viewMoreHotelsBtn:hover,
    #viewMoreRestsBtn:hover {
      background: rgb(40, 40, 227);
    }

    /* === Loading Overlay === */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 2rem;
      font-weight: bold;
      color: #1a73e8;
      font-family: Arial, sans-serif;
    }

    .myIcon {
      position: absolute;
      right: 0;
      bottom: 1rem;
      left: 89%;
      /* remove your margin-left/margin-top */
    }

    .myHeartICafe,
    .myHeartIHotel {
      position: absolute;
      bottom: 0;
      /* same distance from bottom */
      left: 85%;
      /* same distance from right */
      margin: 0;
      /* remove your margin-left/margin-top */
    }

    .myHeartICafe i,
    .myHeartIHotel i,
    .myIcon i {
      font-size: 1.5rem;
      cursor: pointer;
      transition: 0.2s;
    }

    /* Section overlay */
    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 10;
      display: none;
    }

    #viewMoreBtn,
    #viewMoreCoffeeBtn,
    #viewMoreHotelsBtn,
    #viewMoreRestsBtn {
      display: none;
      padding: 20px 30px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      margin: 2rem auto;
      display: block;
    }

    #viewMoreBtn:hover,
    #viewMoreCoffeeBtn:hover,
    #viewMoreHotelsBtn:hover,
    #viewMoreRestsBtn:hover {
      background: rgb(40, 40, 227);
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 2rem;
      font-weight: bold;
      color: #1a73e8;
      font-family: Arial, sans-serif;
    }

    .myIcon,
    .myHeartICafe,
    .myHeartIHotel {
      position: absolute;
      bottom: 0.5rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
      transition: 0.2s;
    }

    .myIcon i:hover,
    .myHeartICafe i:hover,
    .myHeartIHotel i:hover {
      color: red;
    }
  </style>
</head>

<body>
  <!--header-->
  <div id="header-placeholder"></div>

  <div id="loadingOverlay">Loading...</div>

  <main>
    <div class="headerImg"></div>
    <h1 id="provinceName"></h1>

    <section>
      <div id="placesList"></div>
      <button id="viewMoreBtn">View More</button>
    </section>

    <section>
      <h1>Coffee Shops</h1>
      <div id="coffeeShop">
        <div class="section-overlay" id="coffeeOverlay"></div>
      </div>
      <button id="viewMoreCoffeeBtn">View More</button>
    </section>

    <section>
      <h1>Hotels</h1>
      <div id="hotels">
        <div class="section-overlay" id="hotelOverlay"></div>
      </div>
      <button id="viewMoreHotelsBtn">View More</button>
    </section>

    <section>
      <h1>Restaurants</h1>
      <div id="restElement">
        <div class="section-overlay" id="restOverlay"></div>
      </div>
      <button id="viewMoreRestsBtn">View More</button>
    </section>

    <section id="maps"></section>
  </main>

  <footer></footer>
  <script src="../js/home.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwZvlhgluWctDaCy_hEiVOsDO9AbVLpnA",
      authDomain: "web-travel-19d2c.firebaseapp.com",
      projectId: "web-travel-19d2c",
      storageBucket: "web-travel-19d2c.firebasestorage.app",
      messagingSenderId: "850178211857",
      appId: "1:850178211857:web:c22077d5d1c892f7b071b0",
      measurementId: "G-JF6LPNDYF9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const provinceId = params.get('id');
    localStorage.setItem("lastProvinceId", provinceId);

    const provinceNameEl = document.getElementById("provinceName");
    const headerImg = document.querySelector(".headerImg");
    const myMaps = document.getElementById("maps");

    let allPlaces = [], isExpanded = false;
    let allCoffees = [], coffeeExpanded = false;
    let allHotels = [], hotelExpanded = false;
    let allRests = [], restExpanded = false;

    window.addEventListener("DOMContentLoaded", loadAllData);

    async function loadAllData() {
      await loadProvinceInfo(provinceId);
      await loadPlacesByProvince(provinceId);
      lazyLoadSection("coffeeShop", loadCoffees, "coffeeOverlay");
      lazyLoadSection("hotels", loadHotels, "hotelOverlay");
      lazyLoadSection("restElement", loadRests, "restOverlay");
      document.getElementById("loadingOverlay").style.display = "none";
    }

    async function loadProvinceInfo(provinceId) {
      const q = query(collection(db, "provincesCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          headerImg.innerHTML = `<img src="${data.image}" alt="${data.name}">`;
          provinceNameEl.textContent = data.name;
          if (data.location) {
            const lat = data.location.lat;
            const lng = data.location.lng;
            myMaps.innerHTML = `<iframe src="https://www.google.com/maps?q=${lat},${lng}&hl=es;z=14&output=embed"
              width="100%" height="450" style="border:0;" allowfullscreen loading="lazy"></iframe>`;
          } else {
            myMaps.innerHTML = `<p>Map not available for ${data.name}</p>`;
          }
        });
      }
    }

    // ==================== PLACES =====================
    async function loadPlacesByProvince(provinceId) {
      const q = query(collection(db, "placesCambo"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return;
      allPlaces = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPlaces();
    }

    function renderPlaces() {
      const placesList = document.getElementById("placesList");
      placesList.innerHTML = "";
      const showItems = isExpanded ? allPlaces : allPlaces.slice(0, 6);
      showItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "place-card";
        div.setAttribute("data-id", item.id);
        div.innerHTML = `
          <img class="detailPlace" src="${item.image}" alt="${item.name}">
          <div class="content">
            <h3>${item.name}</h3>
            <p>${item.description}</p>
            <div class="myIcon"><i class="fa-solid fa-heart"></i></div>
          </div>`;
        div.querySelector(".detailPlace").addEventListener("click", () => {
          window.location.href = `placesdetails.html?id=${item.id}`;
        });
        div.querySelector(".myIcon").addEventListener("click", e => {
          e.stopPropagation();
          handleFavoriteClick(div, item, "placeId", "place");
        });
        placesList.appendChild(div);
      });
      markFavoriteHearts();
      const viewBtn = document.getElementById("viewMoreBtn");
      viewBtn.textContent = isExpanded ? "View Less" : "View More";
      viewBtn.style.display = "block";
    }

    document.getElementById("viewMoreBtn").addEventListener("click", () => {
      isExpanded = !isExpanded;
      renderPlaces();
    });

    // ==================== COFFEE =====================
    async function loadCoffees() {
      const q = query(collection(db, "cafeShopCambo"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return;
      allCoffees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderCoffees();
    }

    function renderCoffees() {
      const section = document.getElementById("coffeeShop");
      section.innerHTML = "";
      const showItems = coffeeExpanded ? allCoffees : allCoffees.slice(0, 6);

      showItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "elementStyle";
        div.setAttribute("data-id", item.id);
        div.innerHTML = `
      <img src="${item.image || item.image_placeholder || 'default-placeholder.jpg'}" alt="${item.name}">
      <div class="content">
        <h3>${item.name}</h3>
        <p>${item.address || "N/A"}</p>
        <div class="myHeartICafe"><i class="fa-solid fa-heart"></i></div>
      </div>`;

        // Favorite click
        div.querySelector(".myHeartICafe").addEventListener("click", e => {
          e.stopPropagation();
          handleFavoriteClick(div, item, "itemId", "coffee");
        });

        // Navigate to detail
        div.querySelector("img").addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=coffee&id=${item.id}`;
        });

        section.appendChild(div);
      });

      markFavoriteHearts();

      const btn = document.getElementById("viewMoreCoffeeBtn");
      btn.textContent = coffeeExpanded ? "View Less" : "View More";
      btn.style.display = "block";
    }

    document.getElementById("viewMoreCoffeeBtn").addEventListener("click", () => {
      coffeeExpanded = !coffeeExpanded;
      renderCoffees();
    });


    // ==================== HOTELS =====================
    async function loadHotels() {
      const q = query(collection(db, "hotelCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return;
      allHotels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderHotels();
    }

    function renderHotels() {
      const section = document.getElementById("hotels");
      section.innerHTML = "";
      const showItems = hotelExpanded ? allHotels : allHotels.slice(0, 6);
      showItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "elementStyle";
        div.setAttribute("data-id", item.id);
        div.innerHTML = `
          <img src="${item.image || 'default.jpg'}" alt="${item.name}">
          <div class="content">
            <h3>${item.name}</h3>
            <p>${item.address || "N/A"}</p>
            <div class="myHeartIHotel"><i class="fa-solid fa-heart"></i></div>
          </div>`;

        div.querySelector(".myHeartIHotel").addEventListener("click", e => {
          e.stopPropagation(); // prevent parent click
          handleFavoriteClick(div, item, "itemId", "hotel");
        });

        // Navigate to hotel detail when clicking the image
        div.querySelector("img").addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=hotel&id=${item.id}`;
        });



        section.appendChild(div);
      });
      markFavoriteHearts();
      const btn = document.getElementById("viewMoreHotelsBtn");
      btn.textContent = hotelExpanded ? "View Less" : "View More";
      btn.style.display = "block";
    }

    document.getElementById("viewMoreHotelsBtn").addEventListener("click", () => {
      hotelExpanded = !hotelExpanded;
      renderHotels();
    });

    // ==================== RESTAURANTS =====================
    async function loadRests() {
      const q = query(collection(db, "restaurantsCambodia"), where("provinceId", "==", provinceId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return;
      allRests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderRests();
    }

    function renderRests() {
      const section = document.getElementById("restElement");
      section.innerHTML = "";
      const showItems = restExpanded ? allRests : allRests.slice(0, 6);
      showItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "elementStyle";
        div.setAttribute("data-id", item.id);
        div.innerHTML = `
          <img src="${item.image || 'default.jpg'}" alt="${item.name}">
          <div class="content">
            <h3>${item.name}</h3>
            <p>${item.cuisine || "N/A"}</p>
            <div class="myHeartICafe"><i class="fa-solid fa-heart"></i></div>
          </div>`;
        div.querySelector(".myHeartICafe").addEventListener("click", e => {
          e.stopPropagation();
          handleFavoriteClick(div, item, "itemId", "restaurant");
        });

        div.querySelector("img").addEventListener("click", () => {
          window.location.href = `placesdetails.html?type=restaurant&id=${item.id}`;
        });


        section.appendChild(div);
      });
      markFavoriteHearts();
      const btn = document.getElementById("viewMoreRestsBtn");
      btn.textContent = restExpanded ? "View Less" : "View More";
      btn.style.display = "block";
    }

    document.getElementById("viewMoreRestsBtn").addEventListener("click", () => {
      restExpanded = !restExpanded;
      renderRests();
    });

    // ==================== FAVORITES =====================
    async function handleFavoriteClick(div, itemData, idField = "placeId", type = "place") {
      let favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];
      if (!favorites.some(f => f.id === itemData.id)) {
        favorites.push(itemData);
        localStorage.setItem("favoritePlaces", JSON.stringify(favorites));
        div.querySelector("i").style.color = "red";
      }

      try {
        const userData = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!userData || !userData.id) return;

        await addDoc(collection(db, "userFavorites"), {
          userId: userData.id,
          [idField]: itemData.id,
          name: itemData.name,
          address: itemData.address || "",
          image: itemData.image || "",
          type,
          createdAt: new Date()
        });
      } catch (err) {
        console.error(err);
      }
    }

    function markFavoriteHearts() {
      const favorites = JSON.parse(localStorage.getItem("favoritePlaces")) || [];
      favorites.forEach(fav => {
        const card = document.querySelector(`[data-id='${fav.id}']`);
        if (card) {
          const heartIcon = card.querySelector("i");
          if (heartIcon) heartIcon.style.color = "red";
        }
      });
    }

    // ==================== LAZY LOAD HELPER =====================
    function lazyLoadSection(sectionId, loadFunction, overlayId) {
      const section = document.getElementById(sectionId);
      const overlay = document.getElementById(overlayId);
      if (!section) return;

      const rect = section.getBoundingClientRect();
      if (rect.top < window.innerHeight) {
        if (overlay) overlay.style.display = "block";
        loadFunction().finally(() => { if (overlay) overlay.style.display = "none"; });
        return;
      }

      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            if (overlay) overlay.style.display = "block";
            loadFunction().finally(() => { if (overlay) overlay.style.display = "none"; });
            obs.unobserve(entry.target);
          }
        });
      }, { root: null, threshold: 0.2 });

      observer.observe(section);
    }
  </script>
</body>

</html>