<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Favorite Places</title>
    <link rel="shortcut icon" href="../images/khmer flag.jpg" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Page Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f4f4f4;
        }

        main#mainContent {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }

        /* Back Arrow */
        #myArrow {
            
            cursor: pointer;
            position: absolute;
            left: 10px;
            margin-top: 2rem;
        }

        #myArrow i {
            font-size: 2.5rem;
            color: red;
           
            
        }

        /* Header Text */
        .mainText {
            text-align: center;
            margin-top: 5rem;

        }

        .mainText h1 {
            font-size: 2.5rem;
            color: #333;
            text-transform: uppercase;
        }

        /* Favorites Grid */
        #placeData {
            display: grid;
            grid-template-columns: repeat(3,30%);
            gap: 3rem;
            justify-content: center;
            margin-top: 5rem;
        }

        .inforData {
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            width: 100%;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .inforData:hover {
            transform: scale(1.03) translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .inforData img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .favorite-card {
            padding: 1rem;
        }

        .favorite-card h3 {
            margin: 0 0 0.5rem;
            font-size: 1.2rem;
            color: #333;
        }

        .favorite-card p {
            margin: 0.2rem 0;
            color: #555;
            font-size: 0.9rem;
        }

        .myDIcon {
            position: absolute;
            right: 0.5rem;
            bottom: 0.5rem;
        }

        .myDIcon i {
            font-size: 1.4rem;
            transition: 0.2s;
            cursor: pointer;
        }

        .myDIcon i:hover {
            color: red;
        }

    </style>
</head>

<body>
    <!-- Header placeholder -->
    <div id="header-placeholder"></div>

    <main id="mainContent">
        <!-- Back Button -->
        <div id="myArrow">
            <i class="fa-solid fa-arrow-left"></i>
        </div>

        <!-- Main Text -->
        <section class="mainText">
            <h1>Your Favorite Places</h1>
            <div id="placeData"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="footer">Â© 2025 Travel Cambodia</footer>

    <!-- Home Script -->
    <script src="../js/home.js"></script>

    <!-- Firebase & Favorite Handling -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCwZvlhgluWctDaCy_hEiVOsDO9AbVLpnA",
            authDomain: "web-travel-19d2c.firebaseapp.com",
            projectId: "web-travel-19d2c",
            storageBucket: "web-travel-19d2c.firebasestorage.app",
            messagingSenderId: "850178211857",
            appId: "1:850178211857:web:c22077d5d1c892f7b071b0",
            measurementId: "G-JF6LPNDYF9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const backArrow = document.getElementById("myArrow");
        const placeDataDiv = document.getElementById("placeData");
        console.log("placeDataDiv:", placeDataDiv);

        // Back button
        backArrow.addEventListener("click", () => history.back());
        console.log("backArrow:", backArrow);

        // User data
        const userData = JSON.parse(localStorage.getItem("loggedInUser"));
        console.log("userData:", userData);

        // Favorites helpers
        function getFavorites() {
            return JSON.parse(localStorage.getItem("favoritePlaces")) || [];
        }

        function saveFavorites(favorites) {
            localStorage.setItem("favoritePlaces", JSON.stringify(favorites));
        }

        // Load favorites
        async function loadFavorites() {
            if (!userData || !userData.id) {
                placeDataDiv.innerHTML = "<p>Please log in first.</p>";
                return;
                
            }

            const q = query(collection(db, "userFavorites"), where("userId", "==", userData.id));
            console.log("qLoadFav:",q);

            const snap = await getDocs(q);
            console.log("snapLoadFav:", snap);

            if (snap.empty) {
                placeDataDiv.innerHTML = "<p>No favorite places yet.</p>";
                saveFavorites([]);
                return;
            }

            let favs = [];
            snap.forEach(docu => {
                const data = docu.data();
                console.log("dataLoadFav:",data);

                favs.push({
                    id: data.itemId,
                    type: data.type,
                    name: data.name,
                    image: data.image || "",
                    address: data.address || "",
                    fireId: docu.id
                });

                console.log("favs:",favs);
            });

            // Sort by type then name
            favs.sort((a, b) => {
                if (a.type.toLowerCase() < b.type.toLowerCase()) return -1;
                if (a.type.toLowerCase() > b.type.toLowerCase()) return 1;
                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });

            // Generate HTML
            placeDataDiv.innerHTML = favs.map(fav => `
                <section class="inforData" data-fire-id="${fav.fireId}" data-id="${fav.id}" data-type="${fav.type}">
                    <div class="myDIcon"><i class="fa-solid fa-trash"></i></div>
                    <img src="${fav.image || 'default.jpg'}" alt="${fav.name}">
                    <div class="favorite-card">
                        <h3>${fav.name}</h3>
                        <p>${fav.address || ""}</p>
                        <p>Type: ${fav.type}</p>
                    </div>
                </section>
            `).join("");

            saveFavorites(favs);
            attachDeleteButtons();
            console.log("dataDiv:", placeDataDiv);

            setTimeout(() => {
                document.querySelectorAll('.newItem').forEach(el => el.classList.remove('newItem'));
            }, 500);

        }

        // Delete favorites
        function attachDeleteButtons() {
            document.querySelectorAll(".myDIcon").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const parent = btn.closest(".inforData");
                    parent.classList.add("deleting");

                    console.log("parent:",parent);

                    setTimeout(async () => {
                        const fireId = parent.getAttribute("data-fire-id");
                        const itemId = parent.getAttribute("data-id");
                        const type = parent.getAttribute("data-type");

                        await deleteDoc(doc(db, "userFavorites", fireId));

                        let favorites = getFavorites();
                        favorites = favorites.filter(f => !(f.id === itemId && f.type === type));
                        saveFavorites(favorites);

                        parent.remove();
                        window.dispatchEvent(new Event("favoritesUpdated"));

                    }, 400);
                });
            });
        }

        // Initialize
        loadFavorites();
    </script>
</body>

</html>
